<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>helloDataViz · CSE 135</title>
    <script src="/assets/collector.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      header {
        margin-bottom: 16px;
      }
      .status {
        font-size: 14px;
      }
      .grid {
        display: grid;
        gap: 20px;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 2fr 1fr;
        }
        .wide {
          grid-column: 1 / 3;
        }
      }
      .chart {
        width: 100%;
        height: 360px;
        border: 1px solid;
      }
      h2 {
        margin: 0 0 6px;
        font-size: 18px;
      }
      p.sub {
        margin: 0 0 10px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>helloDataViz</h1>
      <p>Live data</p>
      <div class="status" id="status">Loading…</div>
    </header>

    <!-- 3-series line chart -->
    <section class="grid">
      <article class="wide">
        <h2>Page Load Percentiles (ms)</h2>
        <p class="sub">p50 / p90 / p99 by minute</p>
        <div id="linePct" class="chart"></div>
      </article>

      <!-- 2-series bar chart -->
      <article>
        <h2>Page Visits by Path (Top 10)</h2>
        <p class="sub">Counts of path visits</p>
        <div id="barPageVisits" class="chart"></div>
      </article>

      <!-- Pie chart -->
      <article>
        <h2>User Languages</h2>
        <p class="sub">Pie chart of user language distribution</p>
        <div id="pieLang" class="chart"></div>
      </article>
    </section>

    <script>
      const statusEl = document.getElementById("status");

      async function fetchJSON(url) {
        const res = await fetch(url, { credentials: "include" });
        const text = await res.text();
        if (!res.ok)
          throw new Error(
            `${url} -> ${res.status} ${res.statusText}\n${text.slice(0, 500)}`
          );
        try {
          return JSON.parse(text);
        } catch {
          throw new Error(`${url} returned non-JSON:\n${text.slice(0, 500)}`);
        }
      }

      const toArray = (x) =>
        Array.isArray(x)
          ? x
          : x && Array.isArray(x.data)
          ? x.data
          : x && Array.isArray(x.rows)
          ? x.rows
          : x && Array.isArray(x.result)
          ? x.result
          : [];

      const num = (x) => {
        const n = Number(x);
        return Number.isFinite(n) ? n : 0;
      };
      const niceMinute = (t) => {
        const d = new Date(num(t));
        d.setSeconds(0, 0);
        return d.getTime();
      };

      // Percentile helpers
      function percentile(sorted, p) {
        if (!sorted.length) return 0;
        const idx = (p / 100) * (sorted.length - 1);
        const lo = Math.floor(idx),
          hi = Math.ceil(idx);
        if (lo === hi) return sorted[lo];
        const w = idx - lo;
        return Math.round(sorted[lo] * (1 - w) + sorted[hi] * w);
      }

      function perfTransforms(perfRaw, staticRaw) {
        const perf = toArray(perfRaw);
        const stat = toArray(staticRaw);

        const sidToNet = new Map();
        for (const s of stat) {
          const sid = s.sessionId || s.session_id || null;
          const net = s.networkType || s.network_type || "unknown";
          if (sid) sidToNet.set(sid, net);
        }

        const rows = perf.map((r) => {
          const sid = r.sessionId || r.session_id || null;
          const ts = r.timestamp ?? r.ts ?? r.navStart ?? r.start ?? Date.now();
          const total =
            r.totalMs ??
            r.total_ms ??
            (r.loadEnd != null && r.navStart != null
              ? num(r.loadEnd) - num(r.navStart)
              : 0);
          const net = sidToNet.get(sid) || "unknown";
          return { ts: num(ts), total: num(total), net };
        });

        // Percentiles by minute
        const byMin = new Map();
        for (const r of rows) {
          const m = niceMinute(r.ts);
          const arr = byMin.get(m) || [];
          arr.push(r.total);
          byMin.set(m, arr);
        }
        const mins = [...byMin.keys()].sort((a, b) => a - b);
        const labels = mins.map((t) => new Date(t).toLocaleTimeString());
        const p50 = [],
          p90 = [],
          p99 = [];
        for (const m of mins) {
          const arr = byMin.get(m).sort((a, b) => a - b);
          p50.push(percentile(arr, 50));
          p90.push(percentile(arr, 90));
          p99.push(percentile(arr, 99));
        }

        return { labels, p50, p90, p99 };
      }

      // Languages pie
      function langPie(staticRaw) {
        const stat = toArray(staticRaw);
        const counts = new Map();
        for (const r of stat) {
          const lang = (r.language || "unknown").trim();
          counts.set(lang, (counts.get(lang) || 0) + 1);
        }
        return [...counts.entries()].map(([text, value]) => ({
          text,
          values: [value],
        }));
      }

      // Page visits by path
      function pageVisits(staticRaw, topN = 10) {
        const stat = toArray(staticRaw);
        const map = new Map(); // path -> count
        for (const r of stat) {
          let path = r.path || "";
          if (!path && r.pageUrl) {
            try {
              path = new URL(r.pageUrl).pathname;
            } catch {}
          }
          if (!path) path = "(unknown)";
          map.set(path, (map.get(path) || 0) + 1);
        }
        // sort by count desc
        const sorted = [...map.entries()].sort((a, b) => b[1] - a[1]);
        const top = sorted.slice(0, topN);
        const rest = sorted.slice(topN);
        const labels = top.map(([p]) => p);
        const values = top.map(([, c]) => c);
        if (rest.length) {
          labels.push("other");
          values.push(rest.reduce((sum, [, c]) => sum + c, 0));
        }
        return { labels, values };
      }

      function renderPct(labels, p50, p90, p99) {
        zingchart.render({
          id: "linePct",
          height: "100%",
          width: "100%",
          data: {
            type: "line",
            scaleX: { labels },
            scaleY: { label: { text: "ms" } },
            legend: {},
            series: [
              { text: "p50", values: p50 },
              { text: "p90", values: p90 },
              { text: "p99", values: p99 },
            ],
          },
        });
      }

      function renderPageVisits(labels, values) {
        zingchart.render({
          id: "barPageVisits",
          height: "100%",
          width: "100%",
          data: {
            type: "bar",
            scaleX: { labels },
            scaleY: { label: { text: "visits" } },
            series: [{ text: "visits", values }],
          },
        });
      }

      function renderLangPie(series) {
        zingchart.render({
          id: "pieLang",
          height: "100%",
          width: "100%",
          data: {
            type: "pie",
            legend: { visible: true, toggleAction: "remove" },
            series,
          },
        });
      }

      // Boot
      async function loadLive() {
        statusEl.textContent = "Loading live data…";
        try {
          const [perf, stat] = await Promise.all([
            fetchJSON("/api/performance?limit=5000"),
            fetchJSON("/api/static?limit=5000"),
          ]);

          const { labels, p50, p90, p99 } = perfTransforms(perf, stat);
          renderPct(labels, p50, p90, p99);

          const pv = pageVisits(stat, 10);
          renderPageVisits(pv.labels, pv.values);

          renderLangPie(langPie(stat));

          statusEl.textContent = "Live data loaded";
        } catch (err) {
          console.error("[hellodataviz] Live data error:", err);
          statusEl.textContent = "Error loading live data — see console";
        }
      }
      loadLive();
    </script>
  </body>
</html>
